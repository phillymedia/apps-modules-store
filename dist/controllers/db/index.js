"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.db=void 0;var _lodash=require("lodash"),_phillyHelpers=require("philly-helpers"),_config=require("../../config"),_mongoose=require("mongoose"),_mongoose2=_interopRequireDefault(_mongoose);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var autoIndex=!0,createIndexes=!1;_config.debug&&_mongoose2.default.set("debug",!0),"production"===_config.env&&(autoIndex=!1),_mongoose2.default.Promise=global.Promise,_mongoose2.default.connect(_config.database.url,{autoIndex:autoIndex,useMongoClient:!0}).then(function(connection){connection.once("open",function(){_phillyHelpers.log.debug("Mongoose connection open.")}),connection.on("error",function(err){throw _phillyHelpers.log.info("Mongoose default connection error: "+err),new Error("Unable to connect to database!")}),connection.on("disconnected",function(){_phillyHelpers.log.debug("Mongoose default connection disconnected.")}),process.on("SIGINT",function(){connection.close(function(){_phillyHelpers.log.debug("Mongoose default connection disconnected through app termination."),process.exit(0)})})}).catch(function(err){throw _phillyHelpers.log.info("Mongoose default connection error: "+err),new Error("Unable to connect to database!")}),"production"===_config.env&&0===_mongoose2.default.system.indexes.find({name:"arn"}).count()&&(createIndexes=!0),exports.db=_mongoose2.default;var detailModel=require("../../models/Detail"),feedModel=require("../../models/Feed"),logModel=require("../../models/Log"),applicationModel=require("../../models/Application"),topicModel=require("../../models/Topic"),endpointModel=require("../../models/Endpoint"),subscriptionModel=require("../../models/Subscription"),statModel=require("../../models/Stat");if(createIndexes){var promises=(0,_lodash.map)([detailModel,feedModel,statModel,logModel,applicationModel,topicModel,endpointModel,subscriptionModel,statModel],function(model){return model.ensureIndex()});Promise.all(promises,function(err){throw err})}