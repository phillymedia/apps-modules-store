"use strict";var _slicedToArray2=require("babel-runtime/helpers/slicedToArray"),_slicedToArray3=_interopRequireDefault(_slicedToArray2),_lodash=require("lodash"),_async=require("async"),_phillyHelpers=require("philly-helpers"),_config=require("../../../config"),_core=require("../../core"),_core2=_interopRequireDefault(_core),_schema2=require("./schema"),_schema3=_interopRequireDefault(_schema2),_find=require("./find");Object.defineProperty(exports,"__esModule",{value:!0}),exports.addMany=exports.add=void 0;function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var _store=_config.store.detail,_delay=_store.expiresInMinutes;function add(settings,callback){var params={expireAt:(0,_phillyHelpers.minutesFromNow)(_delay),id:settings.id,content:settings.content};_core2.default.add(_schema3.default,params,function(err,data){return err?err.code===_config.database.errors.duplicate?(0,_find.findOne)(settings,callback):callback(err):callback(null,data.content)})}function addMany(documents,callback){(0,_async.map)(documents,function(document,next){var params={expireAt:(0,_phillyHelpers.minutesFromNow)(_delay)};if(document.article)params.id=document.article.item_id||document.article.guid,params.content={article:document.article};else if(document.galleries)params.id=document.galleries.item_id||document.galleries.guid,params.content={galleries:document.galleries};else return next((0,_phillyHelpers.makeError)("BadContent","Tried to add something other than an article or a gallery."));return next(null,params)},function(mapErr,mapped){return mapErr?callback(mapErr):_core2.default.addMany(_schema3.default,mapped,function(err,data){if(err){if(err.code===_config.database.errors.duplicate&&data){var ids=(0,_lodash.map)(data,function(dupError){return dupError.id}),settings={id:ids};if(1===settings.id.length){var _ids=(0,_slicedToArray3.default)(ids,1);settings.id=_ids[0]}return(0,_find.findMany)(settings,callback)}return callback(err)}return(0,_lodash.isArray)(data)?callback(null,(0,_lodash.map)(data,function(datum){return datum.content})):callback(null,data.content)})})}exports.add=add,exports.addMany=addMany;